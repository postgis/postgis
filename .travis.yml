env:
  global:
    - RUNTESTFLAGS=-v
  matrix:
    - CFLAGS="-O3 -march=native -mtune=native"
    - CFLAGS="-O3 -g -fsanitize=address -fno-omit-frame-pointer" LDFLAGS="-fsanitize=address" MATRIX_EVAL="export CC=gcc-6 && export CXX=g++-6"
    - CFLAGS="-O3 -march=native -mtune=native -fno-omit-frame-pointer -Werror"
    - CFLAGS="-O0 --coverage -fprofile-arcs -ftest-coverage" LDFLAGS="--coverage -fprofile-arcs -ftest-coverage"

addons:
  postgresql: "9.6"
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - eatmydata  
      - g++-6
      - libc6-dev

before_install:
  - eval "${MATRIX_EVAL}"
  - sudo sh -c "echo /usr/lib/libeatmydata/libeatmydata.so >> /etc/ld.so.preload"
  - sudo add-apt-repository --yes ppa:ubuntugis/ppa
  - sudo add-apt-repository --yes ppa:ubuntugis/ubuntugis-unstable
  - sudo apt-get update -qq
  - mkdir -p /home/travis/deb && touch /home/travis/deb/__ && sudo cp -n /home/travis/deb/* /var/cache/apt/archives || true
  - sudo apt-get install -y --allow-unauthenticated --no-install-recommends --no-install-suggests libsfcgal1 libsfcgal-dev postgresql-server-dev-9.6 libxml2-utils libcunit1-dev xsltproc docbook-xsl docbook-mathml dblatex libgeos-dev libjson0-dev libprotobuf-c0-dev libgdal-dev
  - sudo sh -c "echo deb http://archive.ubuntu.com/ubuntu/ artful main restricted universe multiverse >> /etc/apt/sources.list"
  - sudo apt-get update -qq
  - sudo apt-get install -y --allow-unauthenticated --no-install-recommends --no-install-suggests binutils
  - cp -n /var/cache/apt/archives/* /home/travis/deb || true
  - cd /home/travis/proj
  - test -f proj-4.9.2.tar.gz || wget -c http://download.osgeo.org/proj/proj-4.9.2.tar.gz
  - test -d proj-4.9.2 || tar zxvf proj-4.9.2.tar.gz
  - cd proj-4.9.2
  - CFLAGS="-O3" LDFLAGS="" ./configure --prefix=/usr || cat config.log
  - CFLAGS="-O3" LDFLAGS="" make -j
  - sudo make install
  - cd /home/travis/build/postgis/postgis/
  - sudo ldconfig
  - ./autogen.sh
  - sudo sh -c "echo /usr/lib/x86_64-linux-gnu/libasan.so.3 > /etc/ld.so.preload"
  - sudo sh -c "echo /usr/lib/libeatmydata/libeatmydata.so >> /etc/ld.so.preload"

after_failure:
  - sudo head -n1000 /var/log/postgresql/postgresql-9.6-main.log 

language: c

compiler: gcc

dist: trusty

cache: 
  ccache: true
  directories:
    - /home/travis/proj
    - /home/travis/deb

script:
  - ./configure CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS" || cat config.log
  - make -j
  - chmod 755 /home/travis
  - sudo chmod -R a+wx /home/travis
  - make check
  - make check RUNTESTFLAGS='--dumprestore'
  - sudo chmod -R a+wx /home/travis
  - sudo make install
  - make installcheck
  - sudo chmod -R a+wx /home/travis
  - make installcheck RUNTESTFLAGS='--dumprestore'
  - bash <(curl -s https://codecov.io/bash)

notifications:
  email: false
  irc:
    channels:
      - "irc.freenode.org#postgis-activity"
    on_success: change
    on_failure: always
    use_notice: false
