TMPDIR?=/tmp

POSTGIS_PGSQL_VERSION=@POSTGIS_PGSQL_VERSION@
POSTGIS_GEOS_VERSION=@POSTGIS_GEOS_VERSION@
POSTGIS_PROJ_VERSION=@POSTGIS_PROJ_VERSION@

TESTS = \
	loader/Point \
	loader/PointM \
	loader/PointZ \
	loader/MultiPoint \
	loader/MultiPointM \
	loader/MultiPointZ \
	loader/Arc \
	loader/ArcM \
	loader/ArcZ \
	loader/Polygon \
	loader/PolygonM \
	loader/PolygonZ \
	regress \
	regress_index \
	regress_index_nulls \
	lwgeom_regress \
	regress_lrs \
	removepoint \
	setpoint \
	simplify \
	snaptogrid \
	affine \
	wkt \
	measures \
	long_xact \
	ctors \
	sql-mm-serialize \
	sql-mm-circularstring \
	sql-mm-compoundcurve \
	sql-mm-curvepoly \
	sql-mm-general \
	sql-mm-multicurve \
	sql-mm-multisurface \
	geojson \
	regress_ogc \
	regress_bdpoly \
	regress_proj \
	kml


PREPROC = \
	sql-mm-circularstring_expected \
	sql-mm-compoundcurve_expected \
	sql-mm-curvepoly_expected \
	sql-mm-multicurve_expected \
	sql-mm-multisurface_expected


# Covers/CoveredBy only if GEOS >= 3.0
ifeq ($(shell expr $(POSTGIS_GEOS_VERSION) ">=" 30),1)
	TESTS += regress_ogc_cover 

# PreparedGeometry only if GEOS >= 3.1
ifeq ($(shell expr $(POSTGIS_GEOS_VERSION) ">=" 31),1)
	TESTS += regress_ogc_prep

endif
endif


all: test 

test check: ../lwgeom/liblwgeom.so ../loader/pgsql2shp ../loader/shp2pgsql $(PREPROC)
	cp ../lwgeom/lwpostgis.sql .
	@USE_VERSION="$(POSTGIS_PGSQL_VERSION)" ./run_test $(TESTS)

../lwgeom/liblwgeom.so:
	$(MAKE) -C ../lwgeom

../loader/pgsql2shp ../loader/shp2pgsql:
	$(MAKE) -C ../loader

$(PREPROC):
	cpp -P -traditional-cpp $@.in | grep -v "^$$" > $@

cleanup:
	@sleep 1
	@dropdb postgis_reg > /dev/null

clean:
	rm -f lwpostgis.sql $(PREPROC)
